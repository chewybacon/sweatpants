import { createFileRoute } from '@tanstack/react-router'
import { createChatHandler } from '@tanstack/framework/handler'
import { getChatProvider, resolvePersona, ollamaProvider, openaiProvider } from '@tanstack/framework/chat'
import { run } from 'effection'

// Auto-discovered tools from src/tools/ (generated by @tanstack/framework)
import { toolList } from '../__generated__/tool-registry.gen'


// Combine all tools
const allTools = [
  ...toolList,
]

// Create the handler with Ollama as default provider
const chatHandler = createChatHandler({
  tools: allTools,
  provider: ollamaProvider, // Default to Ollama
  providerRegistry: {
    ollama: ollamaProvider,
    openai: openaiProvider,
  },
  resolvePersona: resolvePersona,
})

export const Route = createFileRoute('/api/chat')({
  server: {
    handlers: {
      POST: async ({ request }) => {
        console.log(process.env)
        // Use simple handler for now to test basic functionality
        return chatHandler(request)
      },
    },
  },
})
